name: Build Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git flex bison libssl-dev bc build-essential \
          libc6-dev libncurses-dev libelf-dev dwarves ccache

    - name: Create workspace structure
      run: |
        mkdir -p kernel/oneplus
        mkdir -p toolchains

    - name: Clone kernel source (your repo)
      run: |
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git \
          -b lineage-23.0 kernel/oneplus/sm8550 --depth=1

    - name: Clone kernel modules repo
      run: |
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git \
          -b lineage-23.0 kernel/oneplus/sm8550-modules --depth=1

    - name: Clone Alphadroid Clang r547379
      run: |
        cd toolchains
        git clone https://gitlab.com/alphadroid-project/prebuilts_clang_host_linux-x86_clang-r547379.git clang --depth=1
        chmod +x clang/bin/clang

    - name: Export environment vars
      run: |
        echo "CLANG_PATH=$GITHUB_WORKSPACE/toolchains/clang/bin" >> $GITHUB_ENV
        echo "KERNEL_SRC=$GITHUB_WORKSPACE/kernel/oneplus/sm8550" >> $GITHUB_ENV
        echo "OUT_DIR=$GITHUB_WORKSPACE/out" >> $GITHUB_ENV

    - name: Prepare OUT directory
      run: mkdir -p out

    - name: Generate defconfig
      run: |
        export PATH="$CLANG_PATH:$PATH"

        cd $KERNEL_SRC

        export ARCH=arm64
        export SUBARCH=arm64
        export CC=clang
        export LLVM=1
        export LLVM_IAS=1
        export CLANG_TRIPLE=aarch64-linux-gnu-

        make O=$OUT_DIR gki_defconfig

        bash scripts/kconfig/merge_config.sh -m \
          $OUT_DIR/.config \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config

        make O=$OUT_DIR olddefconfig

    - name: Build kernel
      run: |
        export PATH="$CLANG_PATH:$PATH"

        cd $KERNEL_SRC

        export ARCH=arm64
        export SUBARCH=arm64
        export CC=clang
        export LLVM=1
        export LLVM_IAS=1
        export CLANG_TRIPLE=aarch64-linux-gnu-

        make -j$(nproc --all) O=$OUT_DIR

    - name: Package AnyKernel3
      run: |
        git clone https://github.com/Kernel-SU/AnyKernel3 --depth=1 AnyKernel3
        rm -rf AnyKernel3/.git AnyKernel3/.github

        if [[ -f out/arch/arm64/boot/Image.gz-dtb ]]; then
          cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
        elif [[ -f out/arch/arm64/boot/Image ]]; then
          cp out/arch/arm64/boot/Image AnyKernel3/
        fi

        if [[ -f out/arch/arm64/boot/dtbo.img ]]; then
          cp out/arch/arm64/boot/dtbo.img AnyKernel3/
        fi

    - name: Upload AnyKernel3 package
      uses: actions/upload-artifact@v4
      with:
        name: OP12R-Kernel
        path: AnyKernel3/*
