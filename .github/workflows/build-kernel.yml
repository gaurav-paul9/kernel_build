name: Build MikaKernel (OnePlus 12R)

on:
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    env:
      # parallel build factor
      MAKE_JOBS: ${{ runner.os == 'Linux' && (format('{0}', (github.runner.workspace && '') ) || '') }}
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison flex build-essential \
            libssl-dev libelf-dev device-tree-compiler dwarves \
            python3 wget curl git ccache

      - name: Pull toolchains (GCC 4.9 prebuilt used for CROSS_COMPILE helpers)
        run: |
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64-linux-android-4.9
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm-linux-androideabi-4.9

      - name: Pull Alphadroid Clang (r547379)
        run: |
          mkdir -p toolchains
          cd toolchains
          git clone --depth=1 https://gitlab.com/alphadroid-project/prebuilts_clang_host_linux-x86_clang-r547379.git clang
          chmod -R +x clang/bin || true
          cd ..

      - name: Clone kernel source and modules (use exactly your repos)
        run: |
          mkdir -p kernel/oneplus
          cd kernel/oneplus

          # kernel source (your repo)
          git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git -b lineage-23.0 sm8550 --depth=1

          # kernel modules (modules/devicetree tree)
          git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git -b lineage-23.0 sm8550-modules --depth=1

          # show the expected symlink layout (for debugging)
          ls -la ./sm8550 || true
          ls -la ./sm8550-modules || true
          # ensure symlinks inside kernel source resolve to modules tree
          # (we rely on the repo's symlinks; do not change them)

      - name: Build kernel (use defconfig chain you provided)
        run: |
          set -euo pipefail
          # locations
          WORKDIR="$GITHUB_WORKSPACE/kernel/oneplus/sm8550"
          OUTDIR="$WORKDIR/out"
          CLANGDIR="$GITHUB_WORKSPACE/toolchains/clang"
          EXPORT_PATH="$CLANGDIR/bin:$PATH"

          export PATH="$EXPORT_PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export CXX=clang++
          export LLVM=1
          export LLVM_IAS=1
          # Keep CROSS_COMPILE pointing to prebuilt GCC 4.9 for proper linking helpers
          export CROSS_COMPILE="$GITHUB_WORKSPACE/aarch64-linux-android-4.9/bin/aarch64-linux-android-"
          export CROSS_COMPILE_ARM32="$GITHUB_WORKSPACE/arm-linux-androideabi-4.9/bin/arm-linux-androideabi-"

          # create OUT and build
          mkdir -p "$OUTDIR"
          cd "$WORKDIR"

          # ensure clean tree so 'make olddefconfig' doesn't complain
          make mrproper || true

          echo "=== APPLYING DEFCONFIG CHAIN ==="
          make O="$OUTDIR" gki_defconfig
          make O="$OUTDIR" vendor/kalama_GKI.config
          make O="$OUTDIR" vendor/oplus/kalama_GKI.config
          make O="$OUTDIR" vendor/debugfs.config

          echo "=== FINALIZING CONFIG ==="
          make O="$OUTDIR" olddefconfig

          echo "=== BUILDING KERNEL ==="
          JOBS=$(nproc --all)
          make -j"$JOBS" O="$OUTDIR"

      - name: Package kernel into AnyKernel3
        run: |
          cd $GITHUB_WORKSPACE
          git clone --depth=1 https://github.com/Kernel-SU/AnyKernel3 AnyKernel3 || true
          rm -rf AnyKernel3/.git AnyKernel3/.github AnyKernel3/LICENSE AnyKernel3/README.md || true

          OUT="$GITHUB_WORKSPACE/kernel/oneplus/sm8550/out"

          # prefer Image.gz-dtb, then Image-dtb, then Image.gz, then Image
          if [ -f "${OUT}/arch/arm64/boot/Image.gz-dtb" ]; then
            cp "${OUT}/arch/arm64/boot/Image.gz-dtb" AnyKernel3/
          elif [ -f "${OUT}/arch/arm64/boot/Image-dtb" ]; then
            cp "${OUT}/arch/arm64/boot/Image-dtb" AnyKernel3/
          elif [ -f "${OUT}/arch/arm64/boot/Image.gz" ]; then
            cp "${OUT}/arch/arm64/boot/Image.gz" AnyKernel3/
          elif [ -f "${OUT}/arch/arm64/boot/Image" ]; then
            cp "${OUT}/arch/arm64/boot/Image" AnyKernel3/
          else
            echo "No boot Image found in ${OUT}/arch/arm64/boot/"; ls -la "${OUT}/arch/arm64/boot" || true; exit 1
          fi

          # dtbo if present
          if [ -f "${OUT}/arch/arm64/boot/dtbo.img" ]; then
            cp "${OUT}/arch/arm64/boot/dtbo.img" AnyKernel3/
          fi

      - name: Upload AnyKernel3 as artifact
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus12R-Kernel-AnyKernel3
          path: AnyKernel3/*
