name: Build MikaKernel (OnePlus 12R)

on:
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            bc bison flex build-essential \
            libssl-dev libelf-dev dwarves \
            device-tree-compiler python3 wget curl git ccache \
            lzop zip unzip zlib1g-dev liblz4-tool pkg-config

      - name: Pull small prebuilt GCC toolchains (for CROSS_COMPILE helpers)
        run: |
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64-linux-android-4.9
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm-linux-androideabi-4.9

      - name: Pull Alphadroid Clang r547379
        run: |
          mkdir -p toolchains
          cd toolchains
          git clone --depth=1 https://gitlab.com/alphadroid-project/prebuilts_clang_host_linux-x86_clang-r547379.git clang
          cd ..
          chmod -R +x toolchains/clang/bin || true

      - name: Clone kernel source and modules (exact repos you gave)
        run: |
          mkdir -p kernel/oneplus
          cd kernel/oneplus

          # Your kernel source (exact)
          git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git -b lineage-23.0 sm8550 --depth=1

          # Modules/devicetree tree (exact)
          git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git -b lineage-23.0 sm8550-modules --depth=1

          # show layout for logs
          echo "=== kernel tree listing ==="
          ls -la sm8550 || true
          echo "=== modules tree listing ==="
          ls -la sm8550-modules || true

      - name: Build kernel (use defconfig chain from screenshot)
        env:
          # no funky runner expressions; set what we need explicitly
          CLANG_DIR: ${{ github.workspace }}/toolchains/clang
        run: |
          set -euo pipefail

          # paths
          WORKROOT="$GITHUB_WORKSPACE/kernel/oneplus"
          KERNEL_SRC="$WORKROOT/sm8550"
          OUTDIR="$KERNEL_SRC/out"
          THREADS=$(nproc --all)

          # toolchain into PATH
          export PATH="$GITHUB_WORKSPACE/toolchains/clang/bin:$PATH"

          # required env for clang builds
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export CXX=clang++
          export LLVM=1
          export LLVM_IAS=1

          # CROSS_COMPILE helpers (prebuilt GCC 4.9)
          export CROSS_COMPILE="$GITHUB_WORKSPACE/aarch64-linux-android-4.9/bin/aarch64-linux-android-"
          export CROSS_COMPILE_ARM32="$GITHUB_WORKSPACE/arm-linux-androideabi-4.9/bin/arm-linux-androideabi-"

          echo "WORKDIR: $KERNEL_SRC"
          mkdir -p "$OUTDIR"
          cd "$KERNEL_SRC"

          # keep tree clean so olddefconfig will succeed
          make mrproper || true

          echo "=== APPLYING DEFCONFIG CHAIN ==="
          # generate base gki_defconfig and merge vendor fragments exactly as in your screenshot
          make O="$OUTDIR" gki_defconfig
          make O="$OUTDIR" vendor/kalama_GKI.config
          make O="$OUTDIR" vendor/oplus/kalama_GKI.config
          make O="$OUTDIR" vendor/debugfs.config

          echo "=== FINALIZING CONFIG ==="
          make O="$OUTDIR" olddefconfig

          echo "=== BUILDING KERNEL ==="
          make -j"$THREADS" O="$OUTDIR"

          echo "=== BUILD OUTPUT LISTING ==="
          ls -la "$OUTDIR/arch/arm64/boot" || true

      - name: Package kernel into AnyKernel3
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          git clone --depth=1 https://github.com/Kernel-SU/AnyKernel3 AnyKernel3 || true
          rm -rf AnyKernel3/.git AnyKernel3/.github AnyKernel3/LICENSE AnyKernel3/README.md || true

          OUT="$GITHUB_WORKSPACE/kernel/oneplus/sm8550/out"

          # prefer Image.gz-dtb, then Image-dtb, then Image.gz, then Image
          if [ -f "${OUT}/arch/arm64/boot/Image.gz-dtb" ]; then
            cp "${OUT}/arch/arm64/boot/Image.gz-dtb" AnyKernel3/
          elif [ -f "${OUT}/arch/arm64/boot/Image-dtb" ]; then
            cp "${OUT}/arch/arm64/boot/Image-dtb" AnyKernel3/
          elif [ -f "${OUT}/arch/arm64/boot/Image.gz" ]; then
            cp "${OUT}/arch/arm64/boot/Image.gz" AnyKernel3/
          elif [ -f "${OUT}/arch/arm64/boot/Image" ]; then
            cp "${OUT}/arch/arm64/boot/Image" AnyKernel3/
          else
            echo "ERROR: No kernel Image found in ${OUT}/arch/arm64/boot/"; ls -la "${OUT}/arch/arm64/boot" || true; exit 1
          fi

          if [ -f "${OUT}/arch/arm64/boot/dtbo.img" ]; then
            cp "${OUT}/arch/arm64/boot/dtbo.img" AnyKernel3/
          fi

      - name: Upload AnyKernel3 as artifact
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus12R-Kernel-AnyKernel3
          path: AnyKernel3/*
